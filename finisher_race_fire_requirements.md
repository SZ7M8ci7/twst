## 要件定義書: フィニッシャー対火属性 時系列ランキング生成

### 目的
- Flourish のレースチャート用に、フィニッシャー対火属性（今後は全属性）ダメージの「カード×カード」時系列ランキングデータと、組み合わせごとの合成アイコン画像を生成する。

### 対象範囲
- まずは対火属性のみ。
- 粒度は「カード×カード」。両カードがその日時点で実装済みのもののみ対象。
- 日次の上位100件を常に出力（不足時はフィニッシャー×相方なしベースラインで補完）。

### 入力データ
- `src/assets/chara.json`
  - 各カードの基本情報＋`releaseDate`（形式: YYYY/MM/DD）
- `src/assets/characters_info.json`
  - キャラクター名（日英）対応
- 画像アセット（存在が望ましい）
  - `src/assets/img/{カード名}.webp`（カード画像）
  - `src/assets/img/icon/{英語名}.webp`（キャラアイコン）
- 実行環境
  - Node.js 20、`sharp`（画像合成）

### 出力
- データ
  - `generated/finisher_race_fire/data.csv`
  - 列: `name, icon, 2020-03-18, 2020-03-19, …, YYYY-MM-DD`
  - 値: 当日の上位100に採用された組み合わせは整数ダメージ、非採用は0
- 画像
  - `generated/finisher_race_fire/img/{フィニッシャーカード}__{相方キー}.webp`
  - 1画像に2アイコン（横並び）

### 処理要件（時系列の単位処理）
- 最古の実装日から最新まで1日刻みでループ。
- 各日について:
  - **カードリスト作成**: 当日までに実装済みのカードを抽出（`releaseDate <= 当日`）。
  - **バフ辞書作成**: その日のカードリストからバフ辞書を構築（相方カード側も当日実装済みのみ）。
  - **候補生成**:
    - フィニッシャー候補は当日の実装済みSSRカード。
    - 各フィニッシャーに対し、当日利用可能な相方カード由来の全バフでダメージ算出。
    - さらに「相方なし（バフ無し）」ベースラインも候補に追加（常に可、相方はキャラ名表示・キャラアイコン使用）。
  - **ランキング**: 候補をダメージ降順でソートし、上位100件を採用。
  - **出力値埋め**: 採用されたキーの当日値に整数ダメージ、採用されなかった既存キーには0を記録（全日で列が揃う）。

### 計算仕様（`finisherDamage.vue` の近似仕様）
- **対象**: フィニッシャーはSSRカードのみ。フィニッシャー属性は `magic2atr`。
- **ATKベース**: `baseATK = originalMaxATK || max_atk || atk`
- **バディATK加算**:
  - `ATKUP(小)=0.2`, `ATKUP(中)=0.35`（3枠合算）
- **自己バフ**:
  - ATKUP(極小/小/中/大) = 0.1 / 0.2 / 0.35 / 0.5
  - ダメージUP(極小/小/中/大) = 0.02 / 0.05 / 0.0875 / 0.125
  - 特例: `被ダメージUP(中)(相手全体/2T)` は 0.0875 加算
- **相方バフ**:
  - ATKUP(極小/小/中/大/極大) = 0.1 / 0.2 / 0.35 / 0.5 / 0.8（ATKに乗算的加算）
  - 属性ダメUP(極小/小/中/大/極大) = 0.025 / 0.06 / 0.105 / 0.15 / 0.27（ダメージ項に加算）
  - 汎用ダメUP(極小/小/中/大/極大) = 0.0225 / 0.05 / 0.0875 / 0.125 / 0.225（ダメージ項に加算）
  - M3バフは提供側がSSRのときのみ有効（所持判定なし）
- **無属性補正**: `atr === '無' ? 1.1 : 1.0`
- **コンボ係数**: 2.4（フィニッシャー想定）
- **属性相性（vs火の係数）**:
  - `'火'→{ fire:1, water:0.5, flora:1.5, cosmic:1 }`
  - `'水'→{ fire:1.5, water:1, flora:0.5, cosmic:1 }`
  - `'木'→{ fire:0.5, water:1.5, flora:1, cosmic:1 }`
  - `'無'→{ fire:1, water:1, flora:1, cosmic:1 }`
- **ダメージ式（等倍→属性補正）**:
  - `atk = baseATK * (1 + buddyATK + selfATK + partnerATK)`
  - `baseDamage = floor(atk * (cosmicRatio + selfDamage + partnerDamage) * 2.4)`
  - `vsFire = baseDamage * attributeModifiers[magic2atr].fire`

### 画像生成仕様（合成アイコン）
- **バフあり（カード×カード）**:
  - 左: フィニッシャーのカード画像（`src/assets/img/{カード名}.webp`）
  - 右: 相方のカード画像（同上）
- **no buff（相方なし）**:
  - 左: フィニッシャーのカード画像
  - 右: デュオ相手のキャラアイコン（`src/assets/img/icon/{英語名}.webp`）
  - ラベルは「フィニッシャー名（衣装） × 相方キャラ名」
- **相方が存在しない場合のみ** フィニッシャー画像を左右に並べて合成
- **出力**: 128×128 を2枚横並び（間隔8px）、WEBP出力

### データスキーマ（CSV）
- **name**: 表示名（例: `アズール（プラチナジャケット） × ジャミル`）
- **icon**: 合成画像ファイル名（例: `azul_birth4__jamil_birth4.webp` または no buff時はキャラキー）
- **各日付列**: 整数ダメージ（非採用は0）

### 実装/運用
- **スクリプト**: `scripts/generateFinisherRaceFire.js`
- **依存追加**: `sharp`
- **実行例**:
```bash
node scripts/generateFinisherRaceFire.js
```
- **出力先**:
  - `generated/finisher_race_fire/data.csv`
  - `generated/finisher_race_fire/img/*.webp`

### 制約・前提
- `chara.json` に全カードの `releaseDate` が設定済みであること。
- 画像ファイル（カード/アイコン）が存在しない場合、当該組み合わせの合成画像は生成できない場合がある（数値は出力）。
- 初期日付でSSRや相方が少なすぎる場合、no buff を含めても上位10が不足する可能性は低いが、ゼロ埋めで整合は保つ。

### 将来拡張
- 対水/対木/対無 属性版の生成（スクリプトのパラメータ化）
- long形式CSVの出力（Flourishテンプレートに合わせた整形）
- 画像パス（相対/絶対）の出力切替
- `finisherDamage.vue` の計算関数を共通化し厳密一致へ

### 非機能要件
- **再現性**: 同一入力に対し決定的な出力
- **パフォーマンス**: 全日×全カードの評価でも現実的な時間で終了
- **ロギング**: 生成件数、日数、画像生成エラー件数などを標準出力に記録
